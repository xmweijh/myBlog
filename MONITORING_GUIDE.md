# 📊 日志管理与监控告警指南

## 🎯 学习目标

通过本文档，你将学习：
1. ✅ 为什么需要结构化日志
2. ✅ 如何使用 Winston 和 Morgan 记录高质量日志
3. ✅ 如何实现健康检查和性能监控
4. ✅ 生产环境的监控策略

---

## 📝 1. 结构化日志 (Structured Logging)

### 为什么 `console.log` 不够用？
- **不可搜索**：无法按级别（Error/Warn）、时间、模块过滤。
- **无上下文**：不知道是哪个用户、哪个请求触发的。
- **性能差**：同步写入，可能阻塞主线程。

### 我们的解决方案：Winston
我们创建了 `src/utils/logger.ts`，它提供了：
- **多级别**：Error, Warn, Info, Http, Debug。
- **多输出**：
  - 开发环境：带颜色的控制台输出。
  - 生产环境：JSON 格式的文件输出 (`logs/error.log`, `logs/all.log`)。
- **自动时间戳**：每条日志都有精确的时间。

### 如何使用

```typescript
import Logger from '../utils/logger';

// 记录普通信息
Logger.info('服务器启动成功');

// 记录错误（包含堆栈信息）
try {
  // ...
} catch (error) {
  Logger.error('数据库连接失败', error);
}

// 记录警告
Logger.warn('用户尝试访问未授权资源');
```

---

## 🌐 2. HTTP 请求日志

我们使用 `morgan` 配合 `winston` 记录所有 HTTP 请求。

**格式**：
`IP地址 - 方法 URL 状态码 响应大小 - 响应时间 ms`

**示例**：
`::1 - GET /api/articles 200 1024 - 45 ms`

这对于排查"哪个接口慢"或"哪个接口报错多"非常有用。

---

## 💓 3. 健康检查与监控

### 健康检查端点 (`/health`)
这是给负载均衡器或监控服务（如 UptimeRobot）使用的。

**响应示例**：
```json
{
  "status": "OK",
  "timestamp": "2024-02-04T12:00:00.000Z",
  "uptime": 123.45,
  "environment": "production",
  "database": "connected",
  "memory": {
    "heapUsed": "50 MB",
    "rss": "100 MB"
  }
}
```
如果数据库断开，状态码会变为 503，监控服务会立即报警。

### 性能监控端点 (`/api/debug/performance`)
我们集成了自定义的性能监测中间件，可以实时查看：
- **统计信息**：总请求数、平均响应时间、错误率。
- **慢接口**：响应时间最长的接口列表。
- **错误接口**：报错最多的接口列表。

---

## 🚨 4. 生产环境告警策略

在真实生产环境中，建议配置以下告警：

1.  **服务宕机**：如果 `/health` 返回非 200，发送短信/电话告警。
2.  **错误率飙升**：如果 5xx 错误率超过 5%，发送 Slack/邮件通知。
3.  **响应变慢**：如果平均响应时间超过 500ms，发送警告。
4.  **磁盘/内存满**：如果服务器资源不足，发送警告。

**推荐工具**：
- **Sentry**：最佳的错误追踪工具（前端+后端）。
- **Prometheus + Grafana**：最佳的指标监控可视化。
- **ELK Stack (Elasticsearch, Logstash, Kibana)**：最佳的日志分析平台。

---

## 📚 总结

现在你的应用不仅能跑，而且是**可观测的 (Observable)**。
- 你知道它在干什么（日志）。
- 你知道它健不健康（健康检查）。
- 你知道它快不快（性能监控）。

这是从"玩具项目"迈向"企业级应用"的重要一步！
